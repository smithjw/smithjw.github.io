<h2>Comments</h2>

<noscript>
  <div id="error">
    Please enable JavaScript to view the comments powered by the Fediverse.
  </div>
</noscript>

<p>You can use your Fediverse (i.e. Mastodon, among many others) account to reply to this <a class="link"
    href="https://{{ .Site.Params.comment.fediverse.host }}/@{{ .Site.Params.comment.fediverse.user }}/{{ .Params.fediverse }}">post</a>.
</p>
<p id="mastodon-comments-list"></p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.3/purify.min.js"
  integrity="sha512-3dcbndbDLLWfKWevQu8C/1qVRcxx6h+eRDSnn3/pcBZHISRJgsj3u71U/Ad6nQVHrEi05hOSr6Hnb/p0pWc94w=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript">
  var host = '{{ .Site.Params.comment.fediverse.host }}';
  var user = '{{ .Site.Params.comment.fediverse.user }}';
  var id = '{{ .Params.fediverse }}';

  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  var commentsLoaded = false;

  function toot_active(toot, what) {
    var count = toot[what + '_count'];
    return count > 0 ? 'active' : '';
  }

  function toot_count(toot, what) {
    var count = toot[what + '_count'];
    return count > 0 ? count : '';
  }

  function user_account(account) {
    var result = `@${account.acct}`;
    if (account.acct.indexOf('@') === -1) {
      var domain = new URL(account.url);
      result += `@${domain.hostname}`;
    }
    return result;
  }

  function loadComments() {
    if (commentsLoaded) return;

    document.getElementById("mastodon-comments-list").innerHTML = "Loading comments from the Fediverse...";

    fetch('https://' + host + '/api/v1/statuses/' + id + '/context')
      .then(function (response) {
        return response.json();
      })
      .then(function (data) {
        if (data['descendants'] &&
          Array.isArray(data['descendants']) &&
          data['descendants'].length > 0) {
          document.getElementById('mastodon-comments-list').innerHTML = "";
          data['descendants'].forEach(function (reply) {
            reply.account.display_name = escapeHtml(reply.account.display_name);
            reply.account.emojis.forEach(emoji => {
              reply.account.display_name = reply.account.display_name.replace(`:${emoji.shortcode}:`, `<img src="${escapeHtml(emoji.static_url)}" alt="Emoji ${emoji.shortcode}" height="20" width="20" />`);
            });
            mastodonComment =
              `<div class="mastodon-comment">
                  <div class="author">
                    <div class="avatar">
                      <img src="${escapeHtml(reply.account.avatar_static)}" height=60 width=60 alt="">
                    </div>
                    <div class="details">
                      <a class="name" href="${reply.account.url}" rel="nofollow">${reply.account.display_name}</a>
                      <a class="user" href="${reply.account.url}" rel="nofollow">${user_account(reply.account)}</a>
                      <a class="date" href="${reply.url}" rel="nofollow">${reply.created_at.substr(0, 10)} ${reply.created_at.substr(11, 8)}</a>
                    </div>


                  </div>
                  <div class="content">${reply.content}</div>
                  <div class="status">
                    <div class="replies ${toot_active(reply, 'replies')}">
                      <a href="${reply.url}" rel="nofollow"><i class="fa fa-reply fa-fw"></i>${toot_count(reply, 'replies')}</a>
                    </div>
                    <div class="reblogs ${toot_active(reply, 'reblogs')}">
                      <a href="${reply.url}" rel="nofollow"><i class="fa fa-retweet fa-fw"></i>${toot_count(reply, 'reblogs')}</a>
                    </div>
                    <div class="favourites ${toot_active(reply, 'favourites')}">
                      <a href="${reply.url}" rel="nofollow"><i class="fa fa-star fa-fw"></i>${toot_count(reply, 'favourites')}</a>
                    </div>
                  </div>
                </div>`;
            document.getElementById('mastodon-comments-list').appendChild(DOMPurify.sanitize(mastodonComment, { 'RETURN_DOM_FRAGMENT': true }));
          });
        } else {
          document.getElementById('mastodon-comments-list').innerHTML = "<p>Not comments found</p>";
        }

        commentsLoaded = true;
      });
  }

  function respondToVisibility(element, callback) {
    var options = {
      root: null,
    };

    var observer = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.intersectionRatio > 0) {
          callback();
        }
      });
    }, options);

    observer.observe(element);
  }

  var comments = document.getElementById("mastodon-comments-list");
  respondToVisibility(comments, loadComments);
</script>
